import { Component, Input, ViewChild, EventEmitter, Output } from '@angular/core';
import { from } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "../services/stripe-elements.service";
export class StripePaymentRequestButtonComponent {
    constructor(stripeElementsService) {
        this.stripeElementsService = stripeElementsService;
        this.load = new EventEmitter();
        this.change = new EventEmitter();
        this.blur = new EventEmitter();
        this.focus = new EventEmitter();
        this.ready = new EventEmitter();
        this.token = new EventEmitter();
        this.paymentMethod = new EventEmitter();
        this.source = new EventEmitter();
        this.cancel = new EventEmitter();
        this.shippingaddresschange = new EventEmitter();
        this.shippingoptionchange = new EventEmitter();
        this.notavailable = new EventEmitter();
    }
    async ngOnChanges(changes) {
        const options = this.stripeElementsService.mergeOptions(this.options, this.containerClass);
        const elementsOptions = this.elementsOptions;
        const stripe = this.stripe;
        let updateElements = false;
        if (changes.elementsOptions || changes.stripe || !this.elements) {
            const elements = await this.stripeElementsService
                .elements(stripe, elementsOptions)
                .toPromise();
            this.elements = elements;
            updateElements = true;
        }
        if (changes.paymentOptions && this.paymentRequest) {
            this.updateRequest(this.paymentOptions);
        }
        if (changes.options ||
            changes.containerClass ||
            !this.element ||
            updateElements) {
            if (this.element && !updateElements) {
                this.update(options);
            }
            else if (this.elements && updateElements) {
                this.paymentRequest = this.stripeElementsService.paymentRequest(stripe, this.paymentOptions);
                this.paymentRequest.on('token', (ev) => this.token.emit(ev));
                this.paymentRequest.on('paymentmethod', (ev) => this.paymentMethod.emit(ev));
                this.paymentRequest.on('source', (ev) => this.source.emit(ev));
                this.paymentRequest.on('cancel', () => this.cancel.emit());
                this.paymentRequest.on('shippingaddresschange', (ev) => this.shippingaddresschange.emit(ev));
                this.paymentRequest.on('shippingoptionchange', (ev) => this.shippingoptionchange.emit(ev));
                this.element = this.elements.create('paymentRequestButton', {
                    paymentRequest: this.paymentRequest,
                    ...options
                });
                this.canMakePayment().subscribe((result) => {
                    if (result) {
                        this.element.on('click', (ev) => this.change.emit(ev));
                        this.element.on('blur', () => this.blur.emit());
                        this.element.on('focus', () => this.focus.emit());
                        this.element.on('ready', () => this.ready.emit());
                        this.element.mount(this.stripeElementRef.nativeElement);
                        this.load.emit({
                            paymentRequestButton: this.element,
                            paymentRequest: this.paymentRequest
                        });
                    }
                    else {
                        this.notavailable.emit();
                    }
                });
            }
        }
    }
    canMakePayment() {
        return from(this.paymentRequest.canMakePayment());
    }
    update(options) {
        this.element.update(options);
    }
    updateRequest(options) {
        const { currency, total, displayItems, shippingOptions } = options;
        this.paymentRequest.update({
            currency,
            total,
            displayItems,
            shippingOptions
        });
    }
    show() {
        this.paymentRequest.show();
    }
    /**
     * @deprecated
     */
    getButton() {
        return this.element;
    }
}
StripePaymentRequestButtonComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.0", ngImport: i0, type: StripePaymentRequestButtonComponent, deps: [{ token: i1.StripeElementsService }], target: i0.ɵɵFactoryTarget.Component });
StripePaymentRequestButtonComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.0.0", type: StripePaymentRequestButtonComponent, selector: "ngx-stripe-payment-request-button", inputs: { containerClass: "containerClass", paymentOptions: "paymentOptions", options: "options", elementsOptions: "elementsOptions", stripe: "stripe" }, outputs: { load: "load", change: "change", blur: "blur", focus: "focus", ready: "ready", token: "token", paymentMethod: "paymentMethod", source: "source", cancel: "cancel", shippingaddresschange: "shippingaddresschange", shippingoptionchange: "shippingoptionchange", notavailable: "notavailable" }, viewQueries: [{ propertyName: "stripeElementRef", first: true, predicate: ["stripeElementRef"], descendants: true }], usesOnChanges: true, ngImport: i0, template: `<div class="field" #stripeElementRef></div>`, isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.0", ngImport: i0, type: StripePaymentRequestButtonComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'ngx-stripe-payment-request-button',
                    template: `<div class="field" #stripeElementRef></div>`
                }]
        }], ctorParameters: function () { return [{ type: i1.StripeElementsService }]; }, propDecorators: { stripeElementRef: [{
                type: ViewChild,
                args: ['stripeElementRef']
            }], containerClass: [{
                type: Input
            }], paymentOptions: [{
                type: Input
            }], options: [{
                type: Input
            }], elementsOptions: [{
                type: Input
            }], stripe: [{
                type: Input
            }], load: [{
                type: Output
            }], change: [{
                type: Output
            }], blur: [{
                type: Output
            }], focus: [{
                type: Output
            }], ready: [{
                type: Output
            }], token: [{
                type: Output
            }], paymentMethod: [{
                type: Output
            }], source: [{
                type: Output
            }], cancel: [{
                type: Output
            }], shippingaddresschange: [{
                type: Output
            }], shippingoptionchange: [{
                type: Output
            }], notavailable: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudC1yZXF1ZXN0LWJ1dHRvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc3RyaXBlL3NyYy9saWIvY29tcG9uZW50cy9wYXltZW50LXJlcXVlc3QtYnV0dG9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFDTCxTQUFTLEVBRVQsWUFBWSxFQUNaLE1BQU0sRUFHUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQWMsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDOzs7QUEwQnhDLE1BQU0sT0FBTyxtQ0FBbUM7SUF1QzlDLFlBQW1CLHFCQUE0QztRQUE1QywwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBNUJyRCxTQUFJLEdBQUcsSUFBSSxZQUFZLEVBRzdCLENBQUM7UUFFSyxXQUFNLEdBQUcsSUFBSSxZQUFZLEVBRWhDLENBQUM7UUFDTSxTQUFJLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUNoQyxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUNqQyxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUVqQyxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQTRCLENBQUM7UUFDckQsa0JBQWEsR0FBRyxJQUFJLFlBQVksRUFFdkMsQ0FBQztRQUNNLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBNkIsQ0FBQztRQUN2RCxXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUNsQywwQkFBcUIsR0FBRyxJQUFJLFlBQVksRUFFL0MsQ0FBQztRQUNNLHlCQUFvQixHQUFHLElBQUksWUFBWSxFQUU5QyxDQUFDO1FBQ00saUJBQVksR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO0lBSWdCLENBQUM7SUFFbkUsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFzQjtRQUN0QyxNQUFNLE9BQU8s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bnQsXG4gIElucHV0LFxuICBWaWV3Q2hpbGQsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgT3V0cHV0LFxuICBPbkNoYW5nZXMsXG4gIFNpbXBsZUNoYW5nZXNcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7XG4gIFN0cmlwZUVsZW1lbnRzT3B0aW9ucyxcbiAgU3RyaXBlRWxlbWVudHMsXG4gIFBheW1lbnRSZXF1ZXN0T3B0aW9ucyxcbiAgUGF5bWVudFJlcXVlc3QsXG4gIENhbk1ha2VQYXltZW50UmVzdWx0LFxuICBQYXltZW50UmVxdWVzdFVwZGF0ZU9wdGlvbnMsXG4gIFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudCxcbiAgU3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25FbGVtZW50T3B0aW9ucyxcbiAgU3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25FbGVtZW50Q2xpY2tFdmVudCxcbiAgUGF5bWVudFJlcXVlc3RUb2tlbkV2ZW50LFxuICBQYXltZW50UmVxdWVzdFBheW1lbnRNZXRob2RFdmVudCxcbiAgUGF5bWVudFJlcXVlc3RTb3VyY2VFdmVudCxcbiAgUGF5bWVudFJlcXVlc3RTaGlwcGluZ0FkZHJlc3NFdmVudCxcbiAgUGF5bWVudFJlcXVlc3RTaGlwcGluZ09wdGlvbkV2ZW50XG59IGZyb20gJ0BzdHJpcGUvc3RyaXBlLWpzJztcblxuaW1wb3J0IHsgU3RyaXBlSW5zdGFuY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9zdHJpcGUtaW5zdGFuY2UuY2xhc3MnO1xuaW1wb3J0IHsgU3RyaXBlRWxlbWVudHNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvc3RyaXBlLWVsZW1lbnRzLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3gtc3RyaXBlLXBheW1lbnQtcmVxdWVzdC1idXR0b24nLFxuICB0ZW1wbGF0ZTogYDxkaXYgY2xhc3M9XCJmaWVsZFwiICNzdHJpcGVFbGVtZW50UmVmPjwvZGl2PmBcbn0pXG5leHBvcnQgY2xhc3MgU3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25Db21wb25lbnQgaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuICBAVmlld0NoaWxkKCdzdHJpcGVFbGVtZW50UmVmJykgcHVibGljIHN0cmlwZUVsZW1lbnRSZWYhOiBFbGVtZW50UmVmO1xuICBlbGVtZW50ITogU3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25FbGVtZW50O1xuICBwYXltZW50UmVxdWVzdCE6IFBheW1lbnRSZXF1ZXN0O1xuXG4gIEBJbnB1dCgpIGNvbnRhaW5lckNsYXNzOiBzdHJpbmc7XG4gIEBJbnB1dCgpIHBheW1lbnRPcHRpb25zOiBQYXltZW50UmVxdWVzdE9wdGlvbnM7XG4gIEBJbnB1dCgpIG9wdGlvbnM6IFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudE9wdGlvbnM7XG4gIEBJbnB1dCgpIGVsZW1lbnRzT3B0aW9uczogUGFydGlhbDxTdHJpcGVFbGVtZW50c09wdGlvbnM+O1xuICBASW5wdXQoKSBzdHJpcGU6IFN0cmlwZUluc3RhbmNlO1xuXG4gIEBPdXRwdXQoKSBsb2FkID0gbmV3IEV2ZW50RW1pdHRlcjx7XG4gICAgcGF5bWVudFJlcXVlc3RCdXR0b246IFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudDtcbiAgICBwYXltZW50UmVxdWVzdDogUGF5bWVudFJlcXVlc3Q7XG4gIH0+KCk7XG5cbiAgQE91dHB1dCgpIGNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8XG4gICAgU3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25FbGVtZW50Q2xpY2tFdmVudFxuICA+KCk7XG4gIEBPdXRwdXQoKSBibHVyID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICBAT3V0cHV0KCkgZm9jdXMgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIEBPdXRwdXQoKSByZWFkeSA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICBAT3V0cHV0KCkgdG9rZW4gPSBuZXcgRXZlbnRFbWl0dGVyPFBheW1lbnRSZXF1ZXN0VG9rZW5FdmVudD4oKTtcbiAgQE91dHB1dCgpIHBheW1lbnRNZXRob2QgPSBuZXcgRXZlbnRFbWl0dGVyPFxuICAgIFBheW1lbnRSZXF1ZXN0UGF5bWVudE1ldGhvZEV2ZW50XG4gID4oKTtcbiAgQE91dHB1dCgpIHNvdXJjZSA9IG5ldyBFdmVudEVtaXR0ZXI8UGF5bWVudFJlcXVlc3RTb3VyY2VFdmVudD4oKTtcbiAgQE91dHB1dCgpIGNhbmNlbCA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcbiAgQE91dHB1dCgpIHNoaXBwaW5nYWRkcmVzc2NoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8XG4gICAgUGF5bWVudFJlcXVlc3RTaGlwcGluZ0FkZHJlc3NFdmVudFxuICA+KCk7XG4gIEBPdXRwdXQoKSBzaGlwcGluZ29wdGlvbmNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8XG4gICAgUGF5bWVudFJlcXVlc3RTaGlwcGluZ09wdGlvbkV2ZW50XG4gID4oKTtcbiAgQE91dHB1dCgpIG5vdGF2YWlsYWJsZSA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICBlbGVtZW50czogU3RyaXBlRWxlbWVudHM7XG5cbiAgY29uc3RydWN0b3IocHVibGljIHN0cmlwZUVsZW1lbnRzU2VydmljZTogU3RyaXBlRWxlbWVudHNTZXJ2aWNlKSB7fVxuXG4gIGFzeW5jIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5zdHJpcGVFbGVtZW50c1NlcnZpY2UubWVyZ2VPcHRpb25zKFxuICAgICAgdGhpcy5vcHRpb25zLFxuICAgICAgdGhpcy5jb250YWluZXJDbGFzc1xuICAgICk7XG4gICAgY29uc3QgZWxlbWVudHNPcHRpb25zID0gdGhpcy5lbGVtZW50c09wdGlvbnM7XG4gICAgY29uc3Qgc3RyaXBlID0gdGhpcy5zdHJpcGU7XG4gICAgbGV0IHVwZGF0ZUVsZW1lbnRzID0gZmFsc2U7XG5cbiAgICBpZiAoY2hhbmdlcy5lbGVtZW50c09wdGlvbnMgfHwgY2hhbmdlcy5zdHJpcGUgfHwgIXRoaXMuZWxlbWVudHMpIHtcbiAgICAgIGNvbnN0IGVsZW1lbnRzID0gYXdhaXQgdGhpcy5zdHJpcGVFbGVtZW50c1NlcnZpY2VcbiAgICAgICAgLmVsZW1lbnRzKHN0cmlwZSwgZWxlbWVudHNPcHRpb25zKVxuICAgICAgICAudG9Qcm9taXNlKCk7XG4gICAgICB0aGlzLmVsZW1lbnRzID0gZWxlbWVudHM7XG4gICAgICB1cGRhdGVFbGVtZW50cyA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKGNoYW5nZXMucGF5bWVudE9wdGlvbnMgJiYgdGhpcy5wYXltZW50UmVxdWVzdCkge1xuICAgICAgdGhpcy51cGRhdGVSZXF1ZXN0KHRoaXMucGF5bWVudE9wdGlvbnMpO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIGNoYW5nZXMub3B0aW9ucyB8fFxuICAgICAgY2hhbmdlcy5jb250YWluZXJDbGFzcyB8fFxuICAgICAgIXRoaXMuZWxlbWVudCB8fFxuICAgICAgdXBkYXRlRWxlbWVudHNcbiAgICApIHtcbiAgICAgIGlmICh0aGlzLmVsZW1lbnQgJiYgIXVwZGF0ZUVsZW1lbnRzKSB7XG4gICAgICAgIHRoaXMudXBkYXRlKG9wdGlvbnMpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmVsZW1lbnRzICYmIHVwZGF0ZUVsZW1lbnRzKSB7XG4gICAgICAgIHRoaXMucGF5bWVudFJlcXVlc3QgPSB0aGlzLnN0cmlwZUVsZW1lbnRzU2VydmljZS5wYXltZW50UmVxdWVzdChcbiAgICAgICAgICBzdHJpcGUsXG4gICAgICAgICAgdGhpcy5wYXltZW50T3B0aW9uc1xuICAgICAgICApO1xuICAgICAgICB0aGlzLnBheW1lbnRSZXF1ZXN0Lm9uKCd0b2tlbicsIChldikgPT4gdGhpcy50b2tlbi5lbWl0KGV2KSk7XG4gICAgICAgIHRoaXMucGF5bWVudFJlcXVlc3Qub24oJ3BheW1lbnRtZXRob2QnLCAoZXYpID0+XG4gICAgICAgICAgdGhpcy5wYXltZW50TWV0aG9kLmVtaXQoZXYpXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMucGF5bWVudFJlcXVlc3Qub24oJ3NvdXJjZScsIChldikgPT4gdGhpcy5zb3VyY2UuZW1pdChldikpO1xuICAgICAgICB0aGlzLnBheW1lbnRSZXF1ZXN0Lm9uKCdjYW5jZWwnLCAoKSA9PiB0aGlzLmNhbmNlbC5lbWl0KCkpO1xuICAgICAgICB0aGlzLnBheW1lbnRSZXF1ZXN0Lm9uKCdzaGlwcGluZ2FkZHJlc3NjaGFuZ2UnLCAoZXYpID0+XG4gICAgICAgICAgdGhpcy5zaGlwcGluZ2FkZHJlc3NjaGFuZ2UuZW1pdChldilcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5wYXltZW50UmVxdWVzdC5vbignc2hpcHBpbmdvcHRpb25jaGFuZ2UnLCAoZXYpID0+XG4gICAgICAgICAgdGhpcy5zaGlwcGluZ29wdGlvbmNoYW5nZS5lbWl0KGV2KVxuICAgICAgICApO1xuICAgICAgICB0aGlzLmVsZW1lbnQgPSB0aGlzLmVsZW1lbnRzLmNyZWF0ZSgncGF5bWVudFJlcXVlc3RCdXR0b24nLCB7XG4gICAgICAgICAgcGF5bWVudFJlcXVlc3Q6IHRoaXMucGF5bWVudFJlcXVlc3QsXG4gICAgICAgICAgLi4ub3B0aW9uc1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNhbk1ha2VQYXltZW50KCkuc3Vic2NyaWJlKChyZXN1bHQpID0+IHtcbiAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQub24oJ2NsaWNrJywgKGV2KSA9PiB0aGlzLmNoYW5nZS5lbWl0KGV2KSk7XG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQub24oJ2JsdXInLCAoKSA9PiB0aGlzLmJsdXIuZW1pdCgpKTtcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5vbignZm9jdXMnLCAoKSA9PiB0aGlzLmZvY3VzLmVtaXQoKSk7XG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQub24oJ3JlYWR5JywgKCkgPT4gdGhpcy5yZWFkeS5lbWl0KCkpO1xuXG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQubW91bnQodGhpcy5zdHJpcGVFbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpO1xuXG4gICAgICAgICAgICB0aGlzLmxvYWQuZW1pdCh7XG4gICAgICAgICAgICAgIHBheW1lbnRSZXF1ZXN0QnV0dG9uOiB0aGlzLmVsZW1lbnQsXG4gICAgICAgICAgICAgIHBheW1lbnRSZXF1ZXN0OiB0aGlzLnBheW1lbnRSZXF1ZXN0XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ub3RhdmFpbGFibGUuZW1pdCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY2FuTWFrZVBheW1lbnQoKTogT2JzZXJ2YWJsZTxDYW5NYWtlUGF5bWVudFJlc3VsdCB8IG51bGw+IHtcbiAgICByZXR1cm4gZnJvbSh0aGlzLnBheW1lbnRSZXF1ZXN0LmNhbk1ha2VQYXltZW50KCkpO1xuICB9XG5cbiAgdXBkYXRlKG9wdGlvbnM6IFBhcnRpYWw8U3RyaXBlUGF5bWVudFJlcXVlc3RCdXR0b25FbGVtZW50T3B0aW9ucz4pIHtcbiAgICB0aGlzLmVsZW1lbnQudXBkYXRlKG9wdGlvbnMpO1xuICB9XG5cbiAgdXBkYXRlUmVxdWVzdChvcHRpb25zOiBQYXltZW50UmVxdWVzdFVwZGF0ZU9wdGlvbnMpIHtcbiAgICBjb25zdCB7IGN1cnJlbmN5LCB0b3RhbCwgZGlzcGxheUl0ZW1zLCBzaGlwcGluZ09wdGlvbnMgfSA9IG9wdGlvbnM7XG5cbiAgICB0aGlzLnBheW1lbnRSZXF1ZXN0LnVwZGF0ZSh7XG4gICAgICBjdXJyZW5jeSxcbiAgICAgIHRvdGFsLFxuICAgICAgZGlzcGxheUl0ZW1zLFxuICAgICAgc2hpcHBpbmdPcHRpb25zXG4gICAgfSk7XG4gIH1cblxuICBzaG93KCkge1xuICAgIHRoaXMucGF5bWVudFJlcXVlc3Quc2hvdygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBnZXRCdXR0b24oKSB7XG4gICAgcmV0dXJuIHRoaXMuZWxlbWVudDtcbiAgfVxufVxuIl19